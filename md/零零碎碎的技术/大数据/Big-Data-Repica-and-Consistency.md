<!--
title: 大数据日知录 - 数据复制与一致性
date: 2016-12-13 21:49:03
tags:
- Big Data
-->
### 大数据日知录 - 数据复制与一致性
Date: 2016-12-13 21:49:03
## CAP
Consistency, Availability, Partition Tolerance
CAP三要素不可兼得。分布式环境中，分区P不可或许，所以通常在AP和CP之间进行选择，大多数互联网应用和NoSQL会选择AP，关系型数据库则为CA.

实际应用中, P出现问题概率很低，因此不应该简单为了P放弃C或者A. 未发生分区时应该坚持CA，发生分区时，保证A，并最终达到C.
<!-- more -->

# ACID
关系数据库的Atomicity, Consistency, Isolation, Durability. 但是C与CAP的C意义有区别。

## BASE
- Basic Availablity, 绝大多数时间可用
- Soft State, 不要求在任意数据是同步的
- Eventual Consistency, 最终一致性

绝大多数系统采用BASE原则，但是在NoSQL与云存储的发展过程中正在逐步提供局部ACID,全局BASE.

# 一致性模型分类
- 强一致性
- 弱一致性
- 最终一致性
    - 因果一致性
        -   读你所写一致性
            -   会话一致性
    - 单调读一致性 
    - 单调写一致性

# 副本更新策略 
- 同时跟新：通过或者不通过一致性协议，同事更新多个副本。
- 主从式跟新：某个副本为主副本，同步哦或者异步。
    - 同步方式，主副本等待所有副本更新完成
    - 异步方式
        - 所有读请求让主副本响应，保证数据一致性
        - 或者所有副本都可以响应，保证响应时间
    - 混合方式，同步更新部分副本
        -   如RWN

# 一致性协议
## 两阶段提交
Vote and Commit， 协调者与参与者。通过超时判断和参与者互询防止阻塞。只有当所有参与者都是READY状态而协调者崩溃才会导致阻塞。

## 向量时钟
利用分布式环境下事件的偏序关系，通过时间戳和事件绑定来判断事件之间的因果关系

向量时钟数组[P1... Pn], 每次进程发生事件（发消息，接消息或进程内部事件）时，将进行自己的向量时钟位+1，发送消息是，将向量时钟数组跟消息同时发出。
接收进程将自己的向量始终跟发过来的向量时钟比较，取较大值更新自己的向量时钟

向量时钟可用于进行版本控制和数据一致性维护。

## RWN协议
通过R+W>N来保证数据一致性。R跟W可以灵活配置，满足不同的读写需求。读时可以使用向量始终来确定数据版本新旧

## Paxos协议
所有的一致性协议本质上药门市Paxos，要么是它的变体。
- 倡议者
- 接受者
- 学习者
非拜占庭模式: 并发进程可以任意速度进行，失败或重启；进程间通过异步通信，通信事件可以任意长，可以丢失和重发，但消息不允许篡改。
![image](http://codemacro.com/assets/res/paxos/paxos-flow.png)

## Raft
Master-Slave模式。强一致性划分为三个问题，领导者选举，Log复制与安全性。
领导者选举通过心跳和term值来决定

 
