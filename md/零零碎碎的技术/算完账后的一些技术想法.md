### 算完账后的一些技术想法

Date: 11/30/2023

项目要迁移，算了一天的帐，总算差不多了。算是预期之内，不过看着这预算，还是替公司心疼。脑子里又开始思考各种优化。

账单中最大的一块是流量迁移带来的流量税。AWS的基础服务还好，但是流量税基本算是抢劫了。之前的NATGW就已经领教过了，通过自建正向代理，总算给打下来了80%，但是这次的迁移预算还是不低，因为外网流量实在是太大了。之前刚好和架构师们讨论过K8S自建NAT的方案，网上居然有不少，看来这是大家一起的痛点。很多的CNI看起来已经提供了类似的功能了，Cilium, Calico之类的。相比于7层代理，四层的NAT可以减少大量新建连接和转发的消耗，而且能解决我们代理不支持Dual TLS的问题，技术上和Cost上看上去都很吸引人。但是收益还是要仔细衡量，第一是技术的成熟度和稳定性，对我们这种超高并发的实时服务，要求非常高；第二是迁移的成本，底层CNI的替换是个大工程；第三是维护成本，升级，安全等等；第四是开源风险，毕竟相比于商用方案我们还可以找到乙方，开源只能自担风险。所以这样的决策总是得经过仔细的调研，特别是风险收益比。

类似的另一块是入口流量的NLB。之前也交过很多税了。今年通过GRPC和其他手段，把内部用的NLB都干掉了，剩下来的钱也是百万美元计的。但是公网入口的NLB还在继续使用了，迁移后这部分流量的增长估计也不少。类似于NAT，这对大家是个痛点，也有了方案。MetaLB就是个选择，号称穷人的LoadBalancer。上面说到的自建NAT的优缺点对自建LB同样成立。

这只是最近新想到的几个可能的优化。撇开技术不谈，类似优化是否真的应用，都需要基于ROI的深入评估。对于这两个case，现在应用都为时尚早，需要等流量进一步上来。但是做好技术储备总是必要的，对公司有备无患，对团队和个人的技术深度是个提升，相比于直接用SAAS也更有挑战。

再叨叨一句，云很好但是也很贵很坑，慎入，入了就想办法榨干它。
